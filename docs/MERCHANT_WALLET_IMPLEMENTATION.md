# ุชูููุฐ ูุธุงู ุงููุญูุธุฉ ุงููุงููุฉ ููุชุฌุงุฑ

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุจูุงุก ูุธุงู ูุญูุธุฉ ูุงููุฉ ุดุงูู ููุชุฌุงุฑ ูุชูุงูู ูุน ูุธุงู ุงูุนูููุงุช ุงูุญุงูู ูููุณููููุ ูุน ุชุชุจุน ุฏููู ูุฃุฑุจุงุญ ุงูููุตุฉ.

---

## ๐๏ธ ุงูุจููุฉ ุงูุชุญุชูุฉ (Database)

### **1. ุฌุฏุงูู ุฌุฏูุฏุฉ (4):**

#### `merchant_wallet_balances`
ูุญูุธุฉ ุงูุชุงุฌุฑ - ุชุฎุฒูู ุงูุฃุฑุตุฏุฉ
```sql
- available_balance_sar      -- ุงูุฑุตูุฏ ุงููุชุงุญ ููุณุญุจ
- pending_balance_sar         -- ุงูุฑุตูุฏ ุงููุนูู (ููุฏ ุงูุชูุตูู)
- lifetime_earnings_sar       -- ุฅุฌูุงูู ุงูุฃุฑุจุงุญ
- total_withdrawn_sar         -- ุฅุฌูุงูู ุงููุณุญูุจ
- minimum_withdrawal_sar      -- ุงูุญุฏ ุงูุฃุฏูู ููุณุญุจ (100 ุฑ.ุณ)
```

#### `merchant_transactions`
ุณุฌู ุงููุนุงููุงุช ุงููุงููุฉ ููุชุงุฌุฑ
```sql
- transaction_type           -- COMMISSION_PENDING | COMMISSION_CONFIRMED | WITHDRAWAL_COMPLETED | REFUND
- amount_sar                 -- ุงููุจูุบ
- balance_after_sar          -- ุงูุฑุตูุฏ ุจุนุฏ ุงููุนุงููุฉ
- reference_id               -- ูุนุฑู ุงููุฑุฌุน
- description                -- ุงููุตู
```

#### `merchant_withdrawal_requests`
ุทูุจุงุช ุงูุณุญุจ ูู ุงูุชุฌุงุฑ
```sql
- amount_sar                 -- ุงููุจูุบ ุงููุทููุจ
- status                     -- PENDING | APPROVED | COMPLETED | REJECTED
- payment_method             -- bank_transfer | stc_pay | wallet
- bank_details               -- ุชูุงุตูู ุงูุญุณุงุจ (JSONB)
- processed_by               -- ูุนุงูุฌ ุงูุทูุจ (admin)
- admin_notes                -- ููุงุญุธุงุช ุงูุฅุฏุงุฑุฉ
```

#### `platform_revenue`
ุฃุฑุจุงุญ ุงูููุตุฉ ูู ุงููุจูุนุงุช
```sql
- merchant_base_price_sar    -- ุณุนุฑ ุงูุชุงุฌุฑ ุงูุฃุณุงุณู
- platform_share_sar         -- ูุตูุจ ุงูููุตุฉ (25%)
- affiliate_commission_sar   -- ุนูููุฉ ุงููุณูู
- final_sale_price_sar       -- ุงูุณุนุฑ ุงูููุงุฆู
- status                     -- PENDING | CONFIRMED | REFUNDED
```

### **2. ุชุนุฏููุงุช ุนูู ุงูุฌุฏุงูู ุงูุญุงููุฉ:**

#### `products`
```sql
+ merchant_base_price_sar    -- ุณุนุฑ ุงูุชุงุฌุฑ ุงูุฃุณุงุณู (ุฌุฏูุฏ)
+ catalog_price_sar          -- ุณุนุฑ ุงููุชุงููุฌ = base ร 1.25 (ูุญุณูุจ ุชููุงุฆูุงู)
  price_sar                  -- ุงูุณุนุฑ ุงูููุงุฆู (ูุญุฏุฏู ุงููุณูู)
```

---

## โ๏ธ Functions & Triggers

### **Functions (7):**

1. **`auto_calculate_catalog_price()`**
   - ุญุณุงุจ ุณุนุฑ ุงููุชุงููุฌ ุชููุงุฆูุงู (base ร 1.25)

2. **`initialize_merchant_wallet()`**
   - ุฅูุดุงุก ูุญูุธุฉ ุนูุฏ ุชุณุฌูู ุชุงุฌุฑ ุฌุฏูุฏ

3. **`record_merchant_transaction()`**
   - ุชุณุฌูู ูุนุงููุฉ ูุงููุฉ ูุชุญุฏูุซ ุงูุฑุตูุฏ

4. **`create_merchant_pending_balance()`**
   - ุฅุถุงูุฉ ุฑุตูุฏ ูุนูู ุนูุฏ ุฏูุน ุงูุทูุจ

5. **`confirm_merchant_balance()`**
   - ุชุญููู PENDING โ AVAILABLE ุนูุฏ ุงูุชูุตูู

6. **`process_merchant_withdrawal()`**
   - ูุนุงูุฌุฉ ุทูุจ ุงูุณุญุจ ูู ูุจู ุงูุฅุฏุงุฑุฉ

7. **`reverse_merchant_transaction()`**
   - ุนูุณ ุงููุนุงููุฉ ุนูุฏ ุฅุฑุฌุงุน ุงูููุชุฌ

### **Triggers (6):**

1. **`trg_auto_calculate_catalog_price`** ุนูู `products`
2. **`trg_initialize_merchant_wallet`** ุนูู `profiles`
3. **`trg_create_merchant_pending`** ุนูู `ecommerce_orders`
4. **`trg_confirm_merchant_balance`** ุนูู `order_hub`
5. **`trg_reverse_merchant_transaction`** ุนูู `order_returns`
6. **`trg_merchant_wallet_updated_at`** ุนูู `merchant_wallet_balances`

---

## ๐จ Frontend (React)

### **Hooks (5):**

1. **`useMerchantWallet`** - ูุญูุธุฉ ุงูุชุงุฌุฑ ูุงููุนุงููุงุช
2. **`useMerchantWithdrawals`** - ุทูุจุงุช ุณุญุจ ุงูุชุงุฌุฑ
3. **`useAdminMerchantWithdrawals`** - ุฅุฏุงุฑุฉ ุงูุณุญูุจุงุช (ููุฅุฏุงุฑุฉ)
4. **`usePlatformRevenue`** - ุฃุฑุจุงุญ ุงูููุตุฉ
5. ุชุญุฏูุซ `src/hooks/wallet/index.ts` ูุชุตุฏูุฑ ุงููููุณ ุงูุฌุฏูุฏุฉ

### **Components (4):**

1. **`MerchantWalletCard`** - ุจุทุงูุงุช ุนุฑุถ ุงูุฃุฑุตุฏุฉ (4 ุจุทุงูุงุช)
2. **`MerchantWithdrawalForm`** - ูููุฐุฌ ุทูุจ ุงูุณุญุจ
3. **`MerchantTransactionsList`** - ูุงุฆูุฉ ุงููุนุงููุงุช
4. **`AdminMerchantWithdrawals`** - ุฅุฏุงุฑุฉ ุงูุณุญูุจุงุช (ููุฅุฏุงุฑุฉ)

### **Pages (3):**

1. **`/merchant/wallet`** - ุตูุญุฉ ูุญูุธุฉ ุงูุชุงุฌุฑ
   - ุนุฑุถ ุงูุฃุฑุตุฏุฉ (ูุชุงุญุ ูุนููุ ุฅุฌูุงูู)
   - ุทูุจ ุณุญุจ ุฌุฏูุฏ
   - ุณุฌู ุงูุณุญูุจุงุช
   - ุณุฌู ุงููุนุงููุงุช

2. **`/admin/merchant-withdrawals`** - ุฅุฏุงุฑุฉ ุณุญูุจุงุช ุงูุชุฌุงุฑ
   - ุนุฑุถ ุฌููุน ุงูุทูุจุงุช
   - ููุงููุฉ/ุฑูุถ ุงูุทูุจุงุช
   - ุนุฑุถ ุชูุงุตูู ุงูุญุณุงุจ ุงูุจููู

3. **`/admin/platform-revenue`** - ุฃุฑุจุงุญ ุงูููุตุฉ
   - ุฅุฌูุงูู ุงูุฃุฑุจุงุญ
   - ุงูุฃุฑุจุงุญ ุงููุนููุฉ
   - ุชูุงุตูู ูู ูุนุงููุฉ

### **Navigation:**
- โ ุฅุถุงูุฉ "ุงููุญูุธุฉ ุงููุงููุฉ" ูู `MerchantLayout`
- โ ุฅุถุงูุฉ "ุณุญูุจุงุช ุงูุชุฌุงุฑ" ู "ุฃุฑุจุงุญ ุงูููุตุฉ" ูู `AdminSidebar`

### **ุชุญุฏูุซ ููุงุฐุฌ ุงูููุชุฌุงุช:**
- โ ุชุญุฏูุซ `SimpleProductForm` ูุงุณุชุฎุฏุงู `merchant_base_price_sar`
- โ ุญุณุงุจ ูุนุฑุถ `catalog_price_sar` ุชููุงุฆูุงู
- โ ุดุฑุญ ูุธุงู ุงูุชุณุนูุฑ ููุชุงุฌุฑ ูุน ูุซุงู ุญู
- โ ุชุญุฏูุซ ุนุฑุถ ุงูููุชุฌุงุช ูู `MerchantProducts`

---

## ๐ ุชุฏูู ุงูุนูู (Workflow)

### **1. ุฅุถุงูุฉ ููุชุฌ:**
```
ุงูุชุงุฌุฑ ูุฏุฎู: ุณุนุฑู ุงูุฃุณุงุณู (1000 ุฑูุงู)
    โ
Trigger: auto_calculate_catalog_price
    โ
ุงููุธุงู ูุญุณุจ: catalog_price = 1000 ร 1.25 = 1250 ุฑูุงู
    โ
ุงูููุชุฌ ุฌุงูุฒ ูููุณูููู
```

### **2. ุนูููุฉ ุงูุจูุน:**
```
ุงูุนููู ูุฏูุน: 1500 ุฑูุงู (ุงููุณูู ุญุฏุฏ ุงูุณุนุฑ)
    โ
Trigger: create_merchant_pending_balance
    โ
merchant_wallet: pending += 1000 ุฑูุงู
platform_revenue: platform_share = 250 ุฑูุงู (PENDING)
affiliate commission: 250 ุฑูุงู (PENDING)
```

### **3. ุงูุชูุตูู:**
```
ุงูุทูุจ ูุชู ุชูุตููู
    โ
Trigger: confirm_merchant_balance
    โ
merchant_wallet: pending โ available (1000 ุฑูุงู)
platform_revenue: status = CONFIRMED
merchant_transaction: COMMISSION_CONFIRMED
```

### **4. ุงูุณุญุจ:**
```
ุงูุชุงุฌุฑ ูุทูุจ ุณุญุจ: 500 ุฑูุงู
    โ
merchant_withdrawal_requests: status = PENDING
    โ
ุงูุฅุฏุงุฑุฉ ุชูุงูู
    โ
Function: process_merchant_withdrawal
    โ
merchant_wallet: available -= 500 ุฑูุงู
merchant_wallet: total_withdrawn += 500 ุฑูุงู
merchant_transaction: WITHDRAWAL_COMPLETED
```

### **5. ุงูุฅุฑุฌุงุน:**
```
ุงูุนููู ูุฑุฌุน ุงูููุชุฌ
    โ
Trigger: reverse_merchant_transaction
    โ
merchant_wallet: available -= 1000 ุฑูุงู (ุฃู pending)
platform_revenue: status = REFUNDED
merchant_transaction: REFUND
```

---

## ๐ ุงูุฃูุงู (Security)

### **Row Level Security (RLS):**

ุฌููุน ุงูุฌุฏุงูู ูุญููุฉ ุจู RLS:

- ุงูุชุฌุงุฑ ูุฑูู ููุท ูุญุงูุธูู ููุนุงููุงุชูู
- ุงูุฅุฏุงุฑุฉ ุชุฑู ูู ุดูุก
- ุงุณุชุฎุฏุงู `has_role()` function ูุชุฌูุจ infinite recursion

### **SECURITY DEFINER:**
ุฌููุน ุงูู Functions ุชุณุชุฎุฏู `SECURITY DEFINER` ูุถูุงู:
- ุชูููุฐ ุขูู ููุนูููุงุช ุงููุงููุฉ
- ุนุฏู ุชูุงุนุจ ุงููุณุชุฎุฏููู ุจุงูุฃุฑุตุฏุฉ
- ุชูุงูู ุงูุจูุงูุงุช

---

## ๐ ุงูุฅุญุตุงุฆูุงุช ุงููุชุงุญุฉ

### **ููุชุงุฌุฑ:**
- ุงูุฑุตูุฏ ุงููุชุงุญ
- ุงูุฑุตูุฏ ุงููุนูู
- ุฅุฌูุงูู ุงูุฃุฑุจุงุญ
- ุฅุฌูุงูู ุงููุณุญูุจ
- ุณุฌู ุงููุนุงููุงุช
- ุณุฌู ุงูุณุญูุจุงุช

### **ููุฅุฏุงุฑุฉ:**
- ุฌููุน ุทูุจุงุช ุงูุณุญุจ (ูุนููุฉุ ููุงูู ุนูููุงุ ูุฑููุถุฉ)
- ุฅุฌูุงูู ุฃุฑุจุงุญ ุงูููุตุฉ
- ุงูุฃุฑุจุงุญ ุงููุนููุฉ
- ุชูุงุตูู ูู ูุนุงููุฉ (ุชุงุฌุฑุ ูุณููุ ูุจุงูุบ)

---

## ๐๏ธ ุงูุตูุงูุฉ

### **Scripts SQL:**

#### `sql/create_missing_merchant_wallets.sql`
ุฅูุดุงุก ูุญุงูุธ ููุชุฌุงุฑ ุงูุญุงูููู ุงูุฐูู ูุง ูููููู ูุญุงูุธ

#### `sql/update_existing_products_pricing.sql`
ุชุญุฏูุซ ุงูููุชุฌุงุช ุงูุญุงููุฉ ุจุญููู ุงูุชุณุนูุฑ ุงูุฌุฏูุฏุฉ
- ุญุณุงุจ `merchant_base_price_sar` ูู `price_sar` ุงูุญุงูู
- ุชุนููู `catalog_price_sar`

---

## ๐ ุงูุชูุซูู

### **ุฏููู ุงูุชุงุฌุฑ:**
`docs/MERCHANT_PRICING_GUIDE.md` - ุฏููู ุดุงูู ููุชุฌุงุฑ ูุดุฑุญ:
- ูุธุงู ุงูุชุณุนูุฑ
- ููููุฉ ุนูู ุงููุญูุธุฉ
- ุฏูุฑุฉ ุงูุนูู ุงููุงููุฉ
- ุทุฑููุฉ ุงูุณุญุจ
- ุฃุณุฆูุฉ ุดุงุฆุนุฉ

---

## โ ุงูุงุฎุชุจุงุฑ

### **ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ:**

1. **ุฅูุดุงุก ูุญูุธุฉ:**
   ```sql
   -- ุงูุชุญูู ูู ุฅูุดุงุก ูุญูุธุฉ ููุชุงุฌุฑ ุงูุฌุฏูุฏ
   SELECT * FROM merchant_wallet_balances WHERE merchant_id = 'xxx';
   ```

2. **ุฅุถุงูุฉ ููุชุฌ:**
   - ุชุณุฌูู ุฏุฎูู ูุชุงุฌุฑ
   - ุฅุถุงูุฉ ููุชุฌ ุจุณุนุฑ ุฃุณุงุณู
   - ุงูุชุญูู ูู ุญุณุงุจ catalog_price ุชููุงุฆูุงู

3. **ุนูููุฉ ุจูุน:**
   - ุฅูุดุงุก ุทูุจ ูุชุณุฏูุฏู
   - ุงูุชุญูู ูู ุฒูุงุฏุฉ pending_balance
   - ุงูุชุญูู ูู ุชุณุฌูู platform_revenue

4. **ุงูุชูุตูู:**
   - ุชุบููุฑ ุญุงูุฉ ุงูุทูุจ ุฅูู DELIVERED
   - ุงูุชุญูู ูู ุชุญููู pending โ available
   - ุงูุชุญูู ูู ุชุณุฌูู ุงููุนุงููุฉ

5. **ุงูุณุญุจ:**
   - ุทูุจ ุณุญุจ ูู ุตูุญุฉ ุงููุญูุธุฉ
   - ููุงููุฉ ุงูุฅุฏุงุฑุฉ
   - ุงูุชุญูู ูู ุฎุตู ุงูุฑุตูุฏ

6. **ุงูุฅุฑุฌุงุน:**
   - ุฅูุดุงุก ุทูุจ ุฅุฑุฌุงุน
   - ุงูุชุญูู ูู ุฎุตู ุงููุจูุบ ูู ุงูุฑุตูุฏ

---

## ๐ฎ ุงูุชุทููุฑุงุช ุงููุณุชูุจููุฉ

### **ูุญุชูู:**
- [ ] ุฅุดุนุงุฑุงุช ููุฑูุฉ ุนูุฏ ุชุบููุฑ ุญุงูุฉ ุงูุณุญุจ
- [ ] ุชูุงุฑูุฑ ูุงููุฉ ุดูุฑูุฉ ููุชุฌุงุฑ
- [ ] ุฑุณูู ุจูุงููุฉ ูุชุทูุฑ ุงูุฃุฑุจุงุญ
- [ ] ุชุตุฏูุฑ ุงููุนุงููุงุช (PDF/Excel)
- [ ] ุชุญููู ุชููุงุฆู ููุฃุฑุตุฏุฉ (Auto-withdrawal)
- [ ] ุฏุนู ุนููุงุช ุฅุถุงููุฉ
- [ ] API ููุชูุงูู ูุน ุฃูุธูุฉ ูุญุงุณุจูุฉ

---

## ๐ ุงูุฏุนู ุงูููู

ููุฃุณุฆูุฉ ุฃู ุงููุดุงูู:
- ูุฑุงุฌุนุฉ ุงูุชูุซูู ูู `docs/`
- ูุญุต console logs
- ูุฑุงุฌุนุฉ Supabase Analytics
- ุงูุชูุงุตู ูุน ูุฑูู ุงูุชุทููุฑ

---

**ุชุงุฑูุฎ ุงูุฅูุดุงุก:** 2025-01-27  
**ุงูุฅุตุฏุงุฑ:** 1.0.0  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุฅูุชุงุฌ
