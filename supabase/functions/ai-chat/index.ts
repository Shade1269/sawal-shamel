import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { getCorsHeaders, handleCorsPreflightRequest } from '../_shared/cors.ts';

// Role-specific system prompts for Atlantis Platform
const getRoleSystemPrompt = (userRole: string) => {
  const platformInfo = `
Ø£Ù†Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù…Ù†ØµØ© "Ø£ØªÙ„Ø§Ù†ØªØ³" - Ù…Ù†ØµØ© Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø¨Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø±Ø§Ø¦Ø¯Ø© ÙÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©.

ğŸ° Ø¹Ù† Ù…Ù†ØµØ© Ø£ØªÙ„Ø§Ù†ØªØ³:
- Ù…Ù†ØµØ© ØªØ±Ø¨Ø· Ø§Ù„ØªØ¬Ø§Ø± Ø¨Ø§Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ† Ø¨Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (Affiliates)
- Ø§Ù„ØªØ¬Ø§Ø± ÙŠØ¶ÙŠÙÙˆÙ† Ù…Ù†ØªØ¬Ø§ØªÙ‡Ù… ÙˆÙŠØ­Ø¯Ø¯ÙˆÙ† Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©
- Ø§Ù„Ù…Ø³ÙˆÙ‚ÙˆÙ† ÙŠÙ†Ø´Ø¦ÙˆÙ† Ù…ØªØ§Ø¬Ø±Ù‡Ù… Ø§Ù„Ø®Ø§ØµØ© ÙˆÙŠØ®ØªØ§Ø±ÙˆÙ† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„ØªØ±ÙˆÙŠØ¬ Ù„Ù‡Ø§
- Ø§Ù„Ù…Ø³ÙˆÙ‚ ÙŠÙƒØ³Ø¨ Ø¹Ù…ÙˆÙ„Ø© Ø¹Ù„Ù‰ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹ ØªØªÙ… Ù…Ù† Ø®Ù„Ø§Ù„Ù‡
- Ø§Ù„Ù…Ù†ØµØ© ØªÙˆÙØ± Ù†Ø¸Ø§Ù… ØªØ­Ø§Ù„ÙØ§Øª ÙˆÙ…ÙƒØ§ÙØ¢Øª (Atlantis World) Ù„Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ†

â­ Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ù†ØµØ©:
- Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØ¬Ø± ØªØ³ÙˆÙŠÙ‚ÙŠ Ù…Ø¬Ø§Ù†ÙŠ Ù„Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ†
- Ù†Ø¸Ø§Ù… Ø¹Ù…ÙˆÙ„Ø§Øª Ø´ÙØ§Ù ÙˆÙ…Ø¨Ø§Ø´Ø±
- Ø£Ø¯ÙˆØ§Øª ØªØ³ÙˆÙŠÙ‚ Ù…ØªÙ‚Ø¯Ù…Ø© (ÙƒÙˆØ¨ÙˆÙ†Ø§ØªØŒ Ø±ÙˆØ§Ø¨Ø· Ù…Ø®ØµØµØ©)
- Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ ÙˆØ§Ù„ØªØ­Ø§Ù„ÙØ§Øª (Atlantis World)
- ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø¨Ø´ÙƒÙ„ Ù„Ø­Ø¸ÙŠ
- Ø¯Ø¹Ù… ÙÙ†ÙŠ Ù…ØªÙƒØ§Ù…Ù„
`;

  switch (userRole) {
    case 'admin':
      return `${platformInfo}

ğŸ‘¤ Ø£Ù†Øª ØªØªØ­Ø¯Ø« Ù…Ø¹: Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†ØµØ© (Admin)

Ù…Ù‡Ø§Ù…Ùƒ ÙƒÙ…Ø³Ø§Ø¹Ø¯ Ù„Ù„Ù…Ø¯ÙŠØ±:
1. Ù…Ø³Ø§Ø¹Ø¯ØªÙ‡ ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ø§Ø± ÙˆØ§Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØµØ©
2. ØªÙ‚Ø¯ÙŠÙ… ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†ØµØ©
3. Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø­Ù„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªÙ‚Ù†ÙŠØ© ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
4. ØªÙ‚Ø¯ÙŠÙ… Ù†ØµØ§Ø¦Ø­ Ù„ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†ØµØ©
5. Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø´ÙƒØ§ÙˆÙ‰

ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø³Ø§Ø¹Ø¯ØªÙ‡ ÙÙŠ:
- Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªØ¬Ø§Ø± ÙˆØ§Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ†
- Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø´ÙƒØ§ÙˆÙ‰
- ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª
- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª
- ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
- Ø¥Ø¯Ø§Ø±Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ø§Ù„ÙØ§Øª ÙˆØ§Ù„Ù…ÙƒØ§ÙØ¢Øª`;

    case 'merchant':
      return `${platformInfo}

ğŸ‘¤ Ø£Ù†Øª ØªØªØ­Ø¯Ø« Ù…Ø¹: ØªØ§Ø¬Ø± Ø¹Ù„Ù‰ Ù…Ù†ØµØ© Ø£ØªÙ„Ø§Ù†ØªØ³

Ù…Ù‡Ø§Ù…Ùƒ ÙƒÙ…Ø³Ø§Ø¹Ø¯ Ù„Ù„ØªØ§Ø¬Ø±:
1. Ù…Ø³Ø§Ø¹Ø¯ØªÙ‡ ÙÙŠ Ø¥Ø¶Ø§ÙØ© ÙˆØ¥Ø¯Ø§Ø±Ø© Ù…Ù†ØªØ¬Ø§ØªÙ‡ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØµØ©
2. ØªÙ‚Ø¯ÙŠÙ… Ù†ØµØ§Ø¦Ø­ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ¬Ø°Ø¨ Ø§Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ†
3. Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ù†Ø³Ø¨ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
4. ØªÙ‚Ø¯ÙŠÙ… ØªØ­Ù„ÙŠÙ„Ø§Øª Ø¹Ù† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
5. Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø´Ø­Ù†

ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø³Ø§Ø¹Ø¯ØªÙ‡ ÙÙŠ:
- Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ù†ØµØ©
- ØªØ­Ø¯ÙŠØ¯ Ø£Ø³Ø¹Ø§Ø± ÙˆÙ†Ø³Ø¨ Ø¹Ù…ÙˆÙ„Ø© ØªÙ†Ø§ÙØ³ÙŠØ©
- ØªØ­Ø³ÙŠÙ† ÙˆØµÙ ÙˆØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
- Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³ÙˆÙ‚ÙŠÙ†
- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­
- ÙÙ‡Ù… Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡`;

    case 'affiliate':
      return `${platformInfo}

ğŸ‘¤ Ø£Ù†Øª ØªØªØ­Ø¯Ø« Ù…Ø¹: Ù…Ø³ÙˆÙ‚ Ø¨Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (Affiliate) Ø¹Ù„Ù‰ Ù…Ù†ØµØ© Ø£ØªÙ„Ø§Ù†ØªØ³

Ù…Ù‡Ø§Ù…Ùƒ ÙƒÙ…Ø³Ø§Ø¹Ø¯ Ù„Ù„Ù…Ø³ÙˆÙ‚:
1. Ù…Ø³Ø§Ø¹Ø¯ØªÙ‡ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ®ØµÙŠØµ Ù…ØªØ¬Ø±Ù‡ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠ
2. ØªÙ‚Ø¯ÙŠÙ… Ù†ØµØ§Ø¦Ø­ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø±Ø¨Ø­Ø©
3. Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ ØªØ±ÙˆÙŠØ¬ÙŠ Ø¬Ø°Ø§Ø¨
4. Ø´Ø±Ø­ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­
5. Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ø§Ù„ÙØ§Øª (Atlantis World)

ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø³Ø§Ø¹Ø¯ØªÙ‡ ÙÙŠ:
- Ø¥Ù†Ø´Ø§Ø¡ Ù…ØªØ¬Ø±Ù‡ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠ Ø§Ù„Ø®Ø§Øµ
- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø°Ø§Øª Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø£Ø¹Ù„Ù‰
- Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¨ÙˆÙ†Ø§Øª Ø®ØµÙ… Ù„Ø¹Ù…Ù„Ø§Ø¦Ù‡
- ÙÙ‡Ù… ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­
- Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØªØ­Ø§Ù„ÙØ§Øª ÙˆØ¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø·
- ØªØ®ØµÙŠØµ Ù…Ø¸Ù‡Ø± Ø§Ù„Ù…ØªØ¬Ø±
- Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙˆØ´ÙŠØ§Ù„ Ù…ÙŠØ¯ÙŠØ§
- ÙÙ‡Ù… Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª (Bronze, Silver, Gold, Legendary)`;

    case 'moderator':
      return `${platformInfo}

ğŸ‘¤ Ø£Ù†Øª ØªØªØ­Ø¯Ø« Ù…Ø¹: Ù…Ø´Ø±Ù Ø¹Ù„Ù‰ Ù…Ù†ØµØ© Ø£ØªÙ„Ø§Ù†ØªØ³

Ù…Ù‡Ø§Ù…Ùƒ ÙƒÙ…Ø³Ø§Ø¹Ø¯ Ù„Ù„Ù…Ø´Ø±Ù:
1. Ù…Ø³Ø§Ø¹Ø¯ØªÙ‡ ÙÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
2. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª ÙˆØ§Ù„Ø´ÙƒØ§ÙˆÙ‰
3. Ø¥Ø¯Ø§Ø±Ø© ØºØ±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„Ù…Ø¬ØªÙ…Ø¹
4. ØªÙ‚Ø¯ÙŠÙ… ØªÙ‚Ø§Ø±ÙŠØ± Ø¹Ù† Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø³Ø§Ø¹Ø¯ØªÙ‡ ÙÙŠ:
- Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù†Ù‡
- Ø¥Ø¯Ø§Ø±Ø© Ø­Ø¸Ø± ÙˆÙƒØªÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
- ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø¬ØªÙ…Ø¹
- Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
- Ø¥Ø¯Ø§Ø±Ø© ØºØ±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©`;

    default: // customer
      return `${platformInfo}

ğŸ‘¤ Ø£Ù†Øª ØªØªØ­Ø¯Ø« Ù…Ø¹: Ø¹Ù…ÙŠÙ„ ÙŠØªØ³ÙˆÙ‚ Ø¹Ù„Ù‰ Ø£Ø­Ø¯ Ù…ØªØ§Ø¬Ø± Ø£ØªÙ„Ø§Ù†ØªØ³

Ù…Ù‡Ø§Ù…Ùƒ ÙƒÙ…Ø³Ø§Ø¹Ø¯ Ù„Ù„Ø¹Ù…ÙŠÙ„:
1. Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ø³ØªÙØ³Ø§Ø±Ø§ØªÙ‡ Ø­ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
2. Ù…Ø³Ø§Ø¹Ø¯ØªÙ‡ ÙÙŠ Ø§Ù„ØªØ³ÙˆÙ‚ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
3. ØªÙ‚Ø¯ÙŠÙ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø´Ø­Ù†
4. Ø­Ù„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ ÙˆØ§Ù„Ø´ÙƒØ§ÙˆÙ‰

ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø³Ø§Ø¹Ø¯ØªÙ‡ ÙÙŠ:
- Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹ÙŠÙ†Ø©
- Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
- ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
- Ù…Ø¹Ø±ÙØ© Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ ÙˆØ§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
- Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ØµØ§Ø­Ø¨ Ø§Ù„Ù…ØªØ¬Ø±`;
  }
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return handleCorsPreflightRequest(req);
  }

  const corsHeaders = getCorsHeaders(req);

  try {
    const { messages, storeInfo, products, userRole } = await req.json();
    const LOVABLE_API_KEY = Deno.env.get("LOVABLE_API_KEY");
    
    if (!LOVABLE_API_KEY) {
      console.error("LOVABLE_API_KEY is not configured");
      throw new Error("LOVABLE_API_KEY is not configured");
    }

    // Get role-specific prompt
    const rolePrompt = getRoleSystemPrompt(userRole || 'customer');

    // Build system prompt with role and store context
    let systemPrompt = rolePrompt;

    // Add store context if available (mainly for customer/affiliate roles)
    if (storeInfo || (products && products.length > 0)) {
      systemPrompt += `

Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±:
- Ø§Ù„Ø§Ø³Ù…: ${storeInfo?.store_name || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}
- Ø§Ù„ÙˆØµÙ: ${storeInfo?.bio || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}
- Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${products?.length || 0}

${products && products.length > 0 ? `
Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©:
${products.slice(0, 10).map((p: any) => `
- ${p.title}: ${p.price_sar} Ø±ÙŠØ§Ù„
  Ø§Ù„ÙˆØµÙ: ${p.description}
  Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${p.stock > 0 ? 'Ù…ØªÙˆÙØ±' : 'Ù†ÙØ¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'}
  Ø§Ù„ÙØ¦Ø©: ${p.category}
`).join('\n')}
` : ''}`;
    }

    systemPrompt += `

Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©:
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
- ÙƒÙ† Ù…ÙˆØ¬Ø²Ø§Ù‹ ÙˆÙ…Ø¨Ø§Ø´Ø±Ø§Ù‹ ÙÙŠ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ
- ÙƒÙ† ÙˆØ¯ÙˆØ¯Ø§Ù‹ ÙˆÙ…Ù‡Ù†ÙŠØ§Ù‹`;

    console.log("Calling Lovable AI Gateway for role:", userRole || 'customer');

    const response = await fetch("https://ai.gateway.lovable.dev/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${LOVABLE_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "google/gemini-2.5-flash",
        messages: [
          { role: "system", content: systemPrompt },
          ...messages,
        ],
        stream: true,
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error("AI gateway error:", response.status, errorText);
      
      if (response.status === 429) {
        return new Response(
          JSON.stringify({ error: "ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹." }), 
          {
            status: 429,
            headers: { ...corsHeaders, "Content-Type": "application/json" },
          }
        );
      }
      
      if (response.status === 402) {
        return new Response(
          JSON.stringify({ error: "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ Lovable AI Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ." }), 
          {
            status: 402,
            headers: { ...corsHeaders, "Content-Type": "application/json" },
          }
        );
      }
      
      throw new Error(`AI gateway error: ${response.status}`);
    }

    console.log("Streaming response from AI Gateway");

    return new Response(response.body, {
      headers: { 
        ...corsHeaders, 
        "Content-Type": "text/event-stream",
        "Cache-Control": "no-cache",
        "Connection": "keep-alive"
      },
    });
  } catch (e) {
    console.error("Error in ai-chat function:", e);
    return new Response(
      JSON.stringify({ 
        error: e instanceof Error ? e.message : "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹" 
      }), 
      {
        status: 500,
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      }
    );
  }
});
